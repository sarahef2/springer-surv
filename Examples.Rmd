---
title: "Springer Examples"
author: "Sarah Formentini, sarahef2"
date: "September 27, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,cache = TRUE)
library(survival)
data("cancer")
data("cgd")
data("colon")
```

# Example  
```{r, cache=TRUE,eval=FALSE}
## ##############################################################
## load and process data
## ##############################################################
## libcurl4-openssl-dev, libssl-dev, libxml2-dev
library(GEOquery)
## ##############################################################
## load data
## ##############################################################
## Doesn't work on my computer, but this is where the data came from
gse2034 = getGEO(GEO="GSE2034", destdir="~/data")
#side = readRDS("D:/Data/Documents/Research/survForest/Sarah/Data/Breast/GSE2034.rds")
#Clinical Data
library(readr)
GSE2034_Clinical <- read_delim("Sarah/Data Analysis/GSE2034_Clinical.txt","\t", escape_double = FALSE, trim_ws = TRUE, skip = 7)
##
X = t(gse2034)
Y = GSE2034_Clinical$`time to relapse or last follow-up (months)`
Censor = GSE2034_Clinical$`relapse (1=True)`
```

```{r}
GSE_data <- readRDS("D:/Data/Documents/Research/survForest/Sarah/GSE_Simulations/GSE_data.rds")
X <- GSE_data$X
Y <- GSE_data$Y
Censor <- GSE_data$Censor

Data <- data.frame(X,Y=Y,Censor=Censor)
```

# Study: GSE2034  
[Link](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=gse2034)  
Should download directrlt from website in this file.  Make new github repository with all of this.  Make a webpage.  Include the reduced data on github and code for full data.
##Summary  

>This series represents 180 lymph-node negative relapse free patients and 106 lymph-node negate patients that developed a distant metastasis.
Please see attached patient clinical parameters sheet for more information.
Keywords: other  

## Variables  
Add plots for marginal survival.  Use darkorange and deepskyblue.  Include ER+ and ER-.
In plot, mark censored observations.  Make sure legends are included.
```{r}
library(ggplot2)
ggplot(Data)+geom_histogram(aes(x=Y))+facet_grid(rows=Censor)
table(Censor)
```

## Marginal Screening  
Add their 76 and possibly use median absolute deviation.  Use 576. Mention supplementary file of the code.  
```{r}
library(survival)
weights <- numeric(dim(X)[2])
for(i in 1:dim(X)[2]){
  weights[i] <- summary(coxph(Surv(Y, Censor)~X[,i]))$coefficients[5]
}

Xr <- X[,order(weights)[1:2000]]

test <- sample(dim(X)[1],10,replace = FALSE)
train <- c(1:dim(X)[1])[!(c(1:dim(X)[1] %in% test))]

Data <- data.frame(Xr,Y=Y,Censor=Censor)
```

```{r}
library(randomForestSRC)
#Tuning
mtry_ops <- c(sqrt(dim(Xr)[2]),dim(Xr)[2]/3,dim(Xr)[2])
ns_ops <- c(1,log(length(Y))) #Include log of failure
param_tunings <- expand.grid(mtry=mtry_ops, ns=ns_ops, nsplit=c(0,1))
```

Cite package version
```{r}
#SEED
param_tunings$oob_err <- NA
for(i in 1:dim(param_tunings)[1]){
  fit_ops <- rfsrc(Surv(Y,Censor)~., data = Data[train,], nodesize = param_tunings$ns[i], mtry = param_tunings$mtry[i], nsplit = param_tunings$nsplit[i], ntree = 1000, importance = FALSE, samptype = "swr", sampsize = dim(Data[train,])[1])
  param_tunings$oob_err[i]<-fit_ops$err.rate[length(fit_ops$err.rate)]
}

mtry_opt <- param_tunings$mtry[param_tunings$oob_err==min(param_tunings$oob_err)]
ns_opt <- param_tunings$ns[param_tunings$oob_err==min(param_tunings$oob_err)]
nsplit_opt <- param_tunings$nsplit[param_tunings$oob_err==min(param_tunings$oob_err)]
```

```{r}
fit_opt <- rfsrc(Surv(Y,Censor)~., data = Data[train,], nodesize =ns_opt, mtry = mtry_opt, nsplit = nsplit_opt, ntree = 2500, importance = TRUE, samptype = "swr", sampsize = dim(Data)[1])
pred_opt <- predict(fit_opt, newdata = Data[test,], outcome = "train")
fit_opt
pred_opt
```

```{r}
library(reshape2)
surv <- data.frame(pred_opt$time.interest,t(pred_opt$survival))
melted <- melt(surv,1)
colnames(melted) <- c("Time", "Subject", "Probability")
#melted <- melted[1:(55*10),]

ggplot(melted,aes(x=Time,y=Probability))+geom_line(aes(col=Subject))
plot(pred_opt$time.interest,pred_opt$survival[1,],type = "l")
for(i in 2:10){
  lines(pred_opt$time.interest,pred_opt$survival[i,])
}
```

```{r}
VI <- data.frame(id=c(1:dim(Xr)[2]),variable=colnames(Xr),vi=fit_opt$importance,ord=order(fit_opt$importance))
VI <- VI[order(VI$vi),]
ggplot(VI)+geom_histogram(aes(x=vi),bins=50)+ggtitle("Variable Importance")
```

```{r}
tail(VI)
```

```{r,echo=FALSE,eval=FALSE}
colon <- colon[colon$etype==1,]
head(colon)
dim(colon)
set.seed(5)
cln<-colon[apply(colon, 1, function(row) !any(is.na(row))),]
test_obs <- sample(dim(cln)[1],100)
trainColon <- cln[!(c(1:dim(cln)[1]) %in% test_obs),]
testColon <- cln[test_obs,]
```

```{r,echo=FALSE,eval=FALSE}
library(randomForestSRC)
#Default settings
fit_default <- rfsrc(Surv(time,status)~.,data = trainColon,importance=FALSE)
pred_default <- predict(fit_default, newdata=testColon, outcome = "train")
fit_default$err.rate[1000]
pred_default$err.rate[1000]
```

```{r,echo=FALSE,eval=FALSE}
#Tuning
mtry_ops <- c(1,sqrt(dim(trainColon)[2]),16)
ns_ops <- c(log(dim(trainColon)[1]),(dim(trainColon)[1])^(1/3))
param_tunings <- expand.grid(mtry=mtry_ops, ns=ns_ops)
```

```{r,echo=FALSE,eval=FALSE}
param_tunings$oob_err <- NA
for(i in 1:dim(param_tunings)[1]){
  fit_ops <- rfsrc(Surv(time,status)~., data = trainColon, nodesize = param_tunings$ns[i], mtry = param_tunings$mtry[i], nsplit = 0, ntree = 250, importance = FALSE, samptype = "swr", sampsize = dim(trainColon)[1])
  param_tunings$oob_err[i]<-fit_ops$err.rate[length(fit_default$err.rate)]
}

mtry_opt <- param_tunings$mtry[param_tunings$oob_err==min(param_tunings$oob_err)]
ns_opt <- param_tunings$ns[param_tunings$oob_err==min(param_tunings$oob_err)]
```

```{r,echo=FALSE,eval=FALSE}
fit_opt <- rfsrc(Surv(time,status)~., data = trainColon, nodesize =ns_opt, mtry = mtry_opt, nsplit = 0, ntree = 250, importance = TRUE, samptype = "swr", sampsize = dim(trainColon)[1])
pred_opt <- predict(fit_opt, newdata=testColon, outcome = "train")
fit_default
pred_default
```

```{r,echo=FALSE,eval=FALSE}
sort(fit_opt$importance)
plot(pred_opt$time.interest,pred_opt$survival[1,],type = "l")
for(i in 2:10){
  lines(pred_opt$time.interest,pred_opt$survival[i,])
}
```